version: "3.8"

services:
  # ============================================================
  # 后端 API + 编排引擎
  # ============================================================
  backend:
    build: ./backend
    container_name: swipe-backend
    restart: unless-stopped
    volumes:
      - ./data:/data
    environment:
      - DATABASE_PATH=/data/swipe.db
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_PHONE=${TELEGRAM_PHONE}
      - TELEGRAM_CHANNELS=${TELEGRAM_CHANNELS}
      - PIKPAK_USERNAME=${PIKPAK_USERNAME}
      - PIKPAK_PASSWORD=${PIKPAK_PASSWORD}
      - LINODE_TOKEN=${LINODE_TOKEN}
      - LINODE_REGION=${LINODE_REGION:-ap-northeast}
      - LINODE_TYPE=${LINODE_TYPE:-g6-nanode-1}
      - ARIA2_RPC_URL=${ARIA2_RPC_URL}
      - ARIA2_RPC_SECRET=${ARIA2_RPC_SECRET}
      - AGGREGATION_WINDOW_MINUTES=${AGGREGATION_WINDOW_MINUTES:-5}
      - BATCH_TASK_THRESHOLD=${BATCH_TASK_THRESHOLD:-10}
      - IDLE_DESTROY_MINUTES=${IDLE_DESTROY_MINUTES:-15}
      - DOWNLOAD_BASE_PATH=${DOWNLOAD_BASE_PATH:-/downloads}
    ports:
      - "8000:8000"
    networks:
      - swipe-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================
  # Telegram 采集引擎
  # ============================================================
  collector:
    build: ./collector
    container_name: swipe-collector
    restart: unless-stopped
    volumes:
      - ./data:/data
      - ./sessions:/sessions
    environment:
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_PHONE=${TELEGRAM_PHONE}
      - TELEGRAM_CHANNELS=${TELEGRAM_CHANNELS}
      - SESSION_PATH=/sessions/collector
      - PREVIEWS_PATH=/data/previews
      - BACKEND_URL=http://backend:8000
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - swipe-network

  # ============================================================
  # 筛选前端 (PWA)
  # ============================================================
  frontend:
    build: ./frontend
    container_name: swipe-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - swipe-network

networks:
  swipe-network:
    driver: bridge

# ============================================================
# 说明:
#
# 1. Aria2 服务需要单独部署在 NAS 节点上，不包含在此 compose 文件中
#    请参考 aria2/docker-compose.yml 进行单独部署
#
# 2. 首次启动 collector 时需要进行 Telegram 登录验证
#    请使用 docker-compose logs -f collector 查看验证码提示
#
# 3. 所有敏感配置通过 .env 文件传入
#    请复制 .env.example 为 .env 并填入实际值
# ============================================================
