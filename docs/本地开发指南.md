# 本地开发指南

## 环境要求

- Python 3.11+
- Node.js 20+
- npm 或 pnpm

## 快速开始

### 1. 后端设置

```powershell
# 进入 backend 目录
cd d:\Projects\tinder-swipe\backend

# 创建虚拟环境（推荐）
python -m venv venv
.\venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
Copy-Item .env.example .env
# 编辑 .env 填入实际配置
notepad .env
```

**必需的环境变量**：

```bash
# 数据库路径（本地开发可以用相对路径）
DATABASE_PATH=../data/swipe.db

# Telegram 配置（如果需要测试 Telegram 功能）
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_PHONE=+86xxxxxxxxxx
TELEGRAM_CHANNELS=["channel_username"]
SESSION_PATH=../sessions/collector

# 预览图路径
PREVIEWS_PATH=../data/previews

# Aria2 配置
ARIA2_RPC_URL=http://localhost:6800/jsonrpc
ARIA2_RPC_SECRET=

# 其他配置使用默认值即可
```

**启动后端**：

```powershell
# 在 backend 目录下
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

访问：

- API 文档: http://localhost:8000/docs
- 健康检查: http://localhost:8000/health

---

### 2. 前端设置

```powershell
# 进入 frontend 目录
cd d:\Projects\tinder-swipe\frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

访问：http://localhost:3000

**开发模式下的 API 代理**：

前端开发服务器已配置代理（见 `vite.config.js`），会自动将 `/api` 和 `/previews` 请求转发到 `http://localhost:8000`。

---

## 开发工作流

### 启动完整开发环境

**终端 1 - 后端**：

```powershell
cd d:\Projects\tinder-swipe\backend
.\venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**终端 2 - 前端**：

```powershell
cd d:\Projects\tinder-swipe\frontend
npm run dev
```

### 热重载

- **后端**: uvicorn 的 `--reload` 会监听文件变化自动重启
- **前端**: Vite 自动热重载

---

## 目录结构

```
d:\Projects\tinder-swipe\
├── backend/
│   ├── app/
│   │   ├── api/          # API 路由
│   │   ├── core/         # 核心配置
│   │   ├── models/       # 数据模型
│   │   ├── schemas/      # Pydantic schemas
│   │   ├── services/     # 业务逻辑
│   │   │   └── telegram.py  # Telegram 采集器
│   │   └── main.py       # 应用入口
│   ├── .env              # 环境配置
│   └── requirements.txt  # Python 依赖
│
├── frontend/
│   ├── src/
│   │   ├── components/   # Vue 组件
│   │   ├── views/        # 页面视图
│   │   ├── api/          # API 调用
│   │   └── main.js       # 应用入口
│   ├── package.json      # Node 依赖
│   └── vite.config.js    # Vite 配置
│
├── data/                 # 数据目录
│   ├── swipe.db          # SQLite 数据库
│   └── previews/         # 预览图
│
└── sessions/             # Telegram 会话
    └── collector.session
```

---

## 可选功能

### Telegram 采集器

如果不需要测试 Telegram 功能，可以在 `.env` 中留空 Telegram 配置：

```bash
TELEGRAM_API_ID=
TELEGRAM_API_HASH=
TELEGRAM_PHONE=
```

后端会自动跳过 Telegram 采集器启动，其他功能正常。

### Aria2 下载

本地开发可以：

1. 使用远程 Aria2（配置 `ARIA2_RPC_URL` 为远程地址）
2. 本地安装 Aria2（参考 `aria2/docker-compose.yml`）
3. 跳过下载测试

---

## 常见问题

### Q: 数据库文件在哪里？

A: `d:\Projects\tinder-swipe\data\swipe.db`，首次启动会自动创建。

### Q: 如何重置数据库？

A: 删除 `data/swipe.db` 文件，重启后端会自动重新创建。

### Q: 前端无法连接后端 API？

A:

1. 确认后端已启动在 8000 端口
2. 检查 `vite.config.js` 中的 proxy 配置
3. 浏览器控制台查看具体错误

### Q: Telegram 采集器不工作？

A:

1. 检查 `.env` 中 Telegram 配置是否正确
2. 查看后端日志确认是否启动成功
3. 首次启动需要在控制台输入验证码

### Q: 如何调试 Python 代码？

A: 使用 VS Code 的 Python 调试器：

`.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "FastAPI",
      "type": "python",
      "request": "launch",
      "module": "uvicorn",
      "args": [
        "app.main:app",
        "--reload",
        "--host",
        "0.0.0.0",
        "--port",
        "8000"
      ],
      "cwd": "${workspaceFolder}/backend",
      "env": {
        "PYTHONPATH": "${workspaceFolder}/backend"
      }
    }
  ]
}
```

---

## 生产环境构建

### 前端构建

```powershell
cd frontend
npm run build
# 构建产物在 frontend/dist
```

### 后端部署

如果需要部署，可以：

1. 使用 Docker（参考根目录 `docker-compose.yml`）
2. 直接运行（需要配置 systemd 或 supervisor）

---

## 代码规范

### Python

- 使用 Black 格式化
- 遵循 PEP 8
- 类型提示（Type Hints）

### JavaScript/Vue

- 使用 ESLint
- 遵循 Vue 3 Composition API 风格

---

## 开发提示

1. **修改配置文件后需重启服务**
2. **数据库模型变更需要手动迁移或重置数据库**
3. **Telegram 会话文件不要删除**，避免频繁登录
4. **开发时建议使用测试频道**，避免污染生产数据
